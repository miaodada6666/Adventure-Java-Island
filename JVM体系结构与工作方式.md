# JVM体系结构与工作方式  
JAVA能够跨越计算机硬件组成差异和操作系统的差异在不同的主机上运行，主要就是JVM屏蔽了各个主机之间硬件和软件的差异，使得Java与平台的耦合性交给JVM来解决。爪哇岛的第二站就是从宏观角度上介绍JVM的体系结构和工作方式。
## JVM体系结构
### JVM是个什么东西？
JVM的全称是Java Viutual Machine，也就是Java虚拟机，它运行在一个实际的计算机上并能仿真模拟出各种计算机的功能。我们先来看一下一个真实的计算机如何才能具备计算的功能，从以计算为中心的计算机体系结构来看，他应该具有以下几部分：  
- 指令集：这个计算机所能识别的机器语言的命令集合。
- 计算单元：能够识别并且控制指令执行的功能模块。
- 寻址方式：地址的位数，最小地址和最大地址范围，以及地址的运行规则。
- 寄存器定义：对操作数寄存器、变址寄存器、控制寄存器等的定义、数量和使用方式。
- 存储单元：能够存储操作数和保存操作结构的单元，如内核级缓存、内存和磁盘等等。  
上述五个部分中与代码相关程度最大的还是指令集部分，什么是指令集？他又有什么作用呢？指令集是在CPU中用来计算和控制计算机系统的一套指令的集合，它是体现CPU性能的一个重要标志。那指令集与汇编语言又有什么关系？指令集是可以直接被机器识别的机器码，它必须以二进制格式存储在计算机当中，而汇编语言是能够被人所识别的指令，它在逻辑和顺序上是与机器指令一一对应的。  
每个运行的Java程序都是一个JVM实例，JVM和实体机一样也有一套合适的指令集，这个指令集能够被JVM解析执行，这个指令集我们称为JVM字节码指令集。符合JVM规范的class文件字节码都可以被JVM执行。
### JVM体系机构详解
除了指令集之外，JVM还需要以下四个组成部分：  
- 类加载器：在JVM启动时或者在类运行时将需要的class加载到JVM中并解析成JVM统一使用的对象格式。
- 执行引擎：执行引擎的任务是负责执行class文件中包含的字节码指令，相当于CPU。
- 内存区：将内存划分为若干个区以模拟实际机器上的存储、记录和调度功能模块。例如方法区，堆区，栈区和常量池等。
- 本地方法调用：调用C或C++实现的本地方法的代码返回结果。  
#### 类加载器
类加载器作为JVM的对外接口，具有三个主要的功能：1.将class文件加载到JVM当中；2.将Class字节码重新解析成JVM统一要求的对象格式；3.审查每个类应该由谁来加载（是一种父优先的等级加载机制）。
#### 执行引擎
执行引擎是JVM的核心部分，执行引擎的作用就是解析JVM字节码指令，得到执行结果。执行引擎也就是执行一条条代码的一个流程，每个Java线程都是一个执行引擎的实例。执行引擎一般有两种执行方式：  
直接解释执行：解释器会将代码一句一句的进行解释，没解释一句就运行一句，在这个过程中不会产生机器码文件。
JIT（即时编译器）执行：先编译再执行，需要编译器先将字节码编译成机器码，然后再进行执行，该过程会产生机器码文件.  
在实际JVM当中会对代码进行分类判断，对于热点代码（多次调用的代码和多次执行的循环体）做编译，非热点代码做解释执行。  
#### Java内存管理
JVM的执行引擎在执行一段程序时会存储一些东西，比如操作码需要的操作数，操作码的执行结果等等。具体JVM的内存区域管理和划分会在下一篇文章进行解释！
## JVM工作机制
前面简单分析了JVM的基本结构，下面再简单分析一下JVM是如何执行字节码命令的，也就是前面介绍的执行引擎是如何工作的。
### 机器如何执行代码
我们知道机器语言一般都是和硬件平台息息相关的，而高级语言一般都是屏蔽了所有的硬件平台和软件平台（例如操作系统）。之所以能够屏蔽就是有了编译器，可以将高级语言转化为CPU可以直接执行的机器码。通常一个程序从编写到执行会经历以下一些阶段：  
源代码——>预处理器——>编译器——>汇编程序——>目标代码——>链接器——>可执行程序  
除了源代码和最后的可执行程序，中间的所有环节都是由现代意义上的编译器统一完成的。  
值得注意的是，我们通常所说的编译器都是将某种高级语言直接编译成可执行的目标机器语言。但是实际上还有一些编译器是将一种高级语言编译成另外一种高级语言，或者将低级语言编译成高级语言（反编译），或者将高级语言编译成虚拟机目标语言，如Java编译器等。